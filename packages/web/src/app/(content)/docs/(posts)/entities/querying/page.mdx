# Advanced Querying in Drift KV

Drift KV provides a powerful and flexible querying system that allows you to build complex queries while maintaining type safety.

## Query Structure

A typical query in Drift KV consists of several components:

```typescript
const results = await drift.entities.user.findMany({
  where: {     // Filter conditions
    role: "admin",
  },
  select: {    // Field selection
    id: true,
    name: true,
  },
  orderBy: {   // Sorting
    createdAt: "desc",
  },
  take: 10,    // Pagination
  skip: 0,
});
```

## Where Clauses

### Basic Operators

```typescript
const users = await drift.entities.user.findMany({
  where: {
    // Equality
    role: "admin",
  }
});
```

### Logical Operators

```typescript
const users = await drift.entities.user.findMany({
  where: {
    AND: [
      { age: { gte: 18 } },
      { status: "active" },
      {
        OR: [
          { role: "admin" },
          { role: "moderator" }
        ]
      }
    ],
    NOT: {
      email: { endsWith: "@blocked.com" }
    }
  }
});
```

### String Operations

```typescript
const users = await drift.entities.user.findMany({
  where: {
    // String contains
    name: { contains: "John" },
    
    // Start/End matching
    email: { 
      startsWith: "john.",
      endsWith: "@example.com"
    }
  }
});
```

## Select and Include

### Field Selection

```typescript
const users = await drift.entities.user.findMany({
  select: {
    id: true,
    name: true,
    email: true,
    // Nested selection
    profile: {
      select: {
        bio: true,
        avatar: true
      }
    }
  }
});
```

### Relationship Inclusion

```typescript
const users = await drift.entities.user.findMany({
  include: {
    // Simple inclusion
    profile: true,
    
    // Advanced inclusion with filtering
    posts: {
      select: {
        title: true,
        content: true
      },
      where: {
        published: true
      },
      orderBy: {
        createdAt: "desc"
      },
      take: 5
    },
    
    // Multiple levels of inclusion
    comments: {
      include: {
        replies: {
          where: {
            approved: true
          }
        }
      }
    }
  }
});
```

## Ordering and Pagination

### Order By

```typescript
const users = await drift.entities.user.findMany({
  // Single field ordering
  orderBy: {
    createdAt: "desc"
  }
});

const posts = await drift.entities.post.findMany({
  // Multiple field ordering
  orderBy: {
    priority: "desc",
    createdAt: "asc"
  }
});
```

### Pagination

```typescript
// Offset pagination
const users = await drift.entities.user.findMany({
  skip: 0,    // Skip N records
  take: 10    // Take N records
});

// Cursor-based pagination
const users = await drift.entities.user.findMany({
  cursor: {
    id: "last-id"
  },
  take: 10
});
```

## Aggregations and Grouping

### Count

```typescript
const totalUsers = await drift.entities.user.count();

const activeAdmins = await drift.entities.user.count({
  where: {
    AND: [
      { status: "active" },
      { role: "admin" }
    ]
  }
});
```

### Distinct

```typescript
const uniqueRoles = await drift.entities.user.findMany({
  distinct: ["role"],
  select: {
    role: true
  }
});

const uniqueStatuses = await drift.entities.user.findMany({
  distinct: ["status", "role"],
  select: {
    status: true,
    role: true
  }
});
```

## Advanced Query Patterns

### Dynamic Queries

```typescript
type FilterParams = {
  role?: string;
  status?: string;
  ageRange?: [number, number];
};

function buildQuery(filters: FilterParams) {
  const where: any = {};
  
  if (filters.role) {
    where.role = filters.role;
  }
  
  if (filters.status) {
    where.status = filters.status;
  }
  
  if (filters.ageRange) {
    where.age = {
      gte: filters.ageRange[0],
      lte: filters.ageRange[1]
    };
  }
  
  return where;
}

const users = await drift.entities.user.findMany({
  where: buildQuery({
    role: "admin",
    ageRange: [25, 45]
  })
});
```

### Subqueries

```typescript
// Find users who have published posts
const authors = await drift.entities.user.findMany({
  where: {
    posts: {
      some: {
        published: true
      }
    }
  },
  include: {
    posts: {
      where: {
        published: true
      }
    }
  }
});
```

## Performance Optimization

### Query Best Practices

1. **Selective Fields**
```typescript
// Good: Select only needed fields
const users = await drift.entities.user.findMany({
  select: {
    id: true,
    name: true
  }
});

// Avoid: Selecting all fields
const users = await drift.entities.user.findMany();
```

2. **Efficient Filtering**
```typescript
// Good: Use indexed fields
const user = await drift.entities.user.findUnique({
  where: { email: "user@example.com" }
});

// Avoid: Complex operations on non-indexed fields
const users = await drift.entities.user.findMany({
  where: {
    bio: { contains: "something" }  // Could be slow on large datasets
  }
});
```

3. **Pagination**
```typescript
// Good: Use pagination for large datasets
const users = await drift.entities.user.findMany({
  take: 10,
  skip: 0
});

// Avoid: Fetching large datasets without pagination
const users = await drift.entities.user.findMany();
```

### Indexing Strategy

```typescript
const UserEntity = new DriftEntity({
  // ...
  options: {
    indexes: [
      "email",           // Single field index
      "status",          // Frequently filtered field
      "createdAt",       // Sorting field
      ["role", "status"] // Compound index
    ]
  }
});
```

## Error Handling

```typescript
try {
  const users = await drift.entities.user.findMany({
    where: {
      invalidField: "value"  // This will cause an error
    }
  });
} catch (error) {
  if (error instanceof QueryError) {
    console.error("Invalid query:", error.message);
  } else if (error instanceof ValidationError) {
    console.error("Validation failed:", error.message);
  } else {
    console.error("Unknown error:", error);
  }
}
```

## Type Safety

```typescript
// Define types for your queries
type UserQueryParams = {
  role?: "admin" | "user";
  status?: "active" | "inactive";
  age?: {
    gte?: number;
    lte?: number;
  };
};

// Use with type checking
function queryUsers(params: UserQueryParams) {
  return drift.entities.user.findMany({
    where: params
  });
}

// TypeScript will catch errors
queryUsers({
  role: "invalid",  // Error: invalid role
  age: {
    gte: "18"      // Error: number expected
  }
});
```

## Next Steps

- Learn about [Entity Relationships](./relationships.md)
- Explore [Real-time Subscriptions](../real-time/subscriptions.md)
- Understand [Validation](./validation.md)
- Review [Performance Optimization](../advanced/performance.md)
